package com.bcvgh.controller;

import com.bcvgh.core.exp.ExpUsageImp;
import com.bcvgh.utils.PocUtil;
import javafx.application.Platform;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.scene.control.*;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.GridPane;
import javafx.scene.text.Text;

import java.util.HashMap;

public class VulExploitController {

    @FXML
    private MenuBar VulName;

    @FXML
    private Menu VulChoice;

    @FXML
    private TextArea VulOut;

    @FXML
    private Text exploitType;

    @FXML
    private Button VulExploit;

    @FXML
    private GridPane CustomBar;

    private HashMap<String, String> Extra = new HashMap<>();

    private HashMap<String, Control> ExtraControls = new HashMap<>();

    public void  initialize() {
        this.VulOut.setWrapText(true);
        this.VulOut.setEditable(false);
        this.VulChoice.setText(PocUtil.name);
        switch (PocUtil.type){
            case "sql":
                break;
            case "upload":
                TextArea uploadContext = new TextArea();
                uploadContext.setPrefSize(150,150);
                this.exploitType.setText("上传内容:");
                this.CustomBar.add(uploadContext,0,1);
                Insets marginUpload = new Insets(10, 10, 10, 10);
                this.CustomBar.setMargin(uploadContext, marginUpload);
                this.ExtraControls.put("webshell",uploadContext);
                this.VulExploit.setText("上传");
                break;
            case "exec":
                TextField Command = new TextField();
                Command.setPrefHeight(20);
                this.exploitType.setText("输入命令:");
                this.CustomBar.add(Command,0,1);
                Insets marginCommand = new Insets(10, 5, 10, 0);
                this.CustomBar.setMargin(Command, marginCommand);
                this.ExtraControls.put("command",Command);
                this.VulExploit.setText("执行");
                break;
            case "deserialize":
                break;
        }


    }

    @FXML
    void Exploit(ActionEvent event) {
        this.VulOut.setText("");
        for (String ExtraControl : this.ExtraControls.keySet()){
            Control control = this.ExtraControls.get(ExtraControl);
            if (control instanceof TextArea){
                this.Extra.put(ExtraControl,((TextArea) control).getText());
            }
            else if (control instanceof  TextField){
                this.Extra.put(ExtraControl,((TextField) control).getText());
            }
        }
        ExpUsageImp expUsage = new ExpUsageImp(PocUtil.url, PocUtil.tag, PocUtil.name, this.Extra);
        HashMap<String, String> result = expUsage.result;
//        ArrayList<String> result = expUsage.Result
        try {
            for (String i : result.keySet()){
                if (i.equals("prompt")){
                    Platform.runLater(() -> this.VulOut.appendText(result.get(i)));
                }
                if (i.equals("result")){
                    Platform.runLater(() -> this.VulOut.appendText(result.get(i)));
                }

            }
        }
        catch (Exception e){

        }
    }

}
